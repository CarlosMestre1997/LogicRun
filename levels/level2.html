<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Startie â€“ Level 2</title>
<link rel="stylesheet" href="../style.css">
</head>
<body>
<div id="top-banner">
  <div id="banner-wrapper">
    <div id="banner-left"></div>
    <div id="banner-center">
      <img src="../assets/top-banner.png" alt="StartSchool LOGIC RUN" id="banner-img">
    </div>
    <div id="banner-right"></div>
  </div>
</div>

<div id="game-container">
  <div id="game">
    <canvas id="canvas" width="600" height="300"></canvas>
  </div>
  
  <div id="ui">
    <div id="ui-header">
      <strong>Level 2</strong>
      <div style="display: flex; align-items: center;">
        <span id="score">SCORE: 1000</span>
        <button id="sound-toggle" title="Toggle Sound">ðŸ”Š</button>
      </div>
    </div>
    <div id="terminal-container">
      <textarea id="terminal" spellcheck="false">> move()
> move()
> jump()
> move()</textarea>
    </div>
    <button id="run">Run</button>
    <div id="status"></div>
  </div>
</div>

<div id="nav-buttons">
  <button id="home-btn" class="nav-btn" title="Home"></button>
  <button id="prev-btn" class="nav-btn" title="Previous Level"></button>
  <button id="password-btn" class="nav-btn" title="Enter Password">*</button>
</div>

<!-- Password Modal -->
<div id="password-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Enter Level Password</h2>
    <input type="text" id="password-input" placeholder="Password">
    <button id="password-submit">Go</button>
    <div id="password-error"></div>
  </div>
</div>

<script type="module">
import { createEngine, calculateScore, countCommands } from '../engine/index.js';
import { drawLevel, initRenderer } from '../render/index.js';
import { level2 } from './level2.js';
import { animateCelebration } from '../render/animations.js';
import { initSounds, loadSoundPreference, toggleSound, isSoundEnabled, playBackgroundMusic, saveMusicPosition } from '../utils/sounds.js';

const level = level2;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const engine = createEngine(level);
const status = document.getElementById('status');
const scoreDisplay = document.getElementById('score');
const terminal = document.getElementById('terminal');

// Initialize sounds
loadSoundPreference();
initSounds();

// Start background music automatically when level loads (continues from previous level)
playBackgroundMusic();

// Sound toggle button
const soundToggle = document.getElementById('sound-toggle');
function updateSoundButton() {
  soundToggle.textContent = isSoundEnabled() ? 'ðŸ”Š' : 'ðŸ”‡';
  soundToggle.classList.toggle('muted', !isSoundEnabled());
}
updateSoundButton();

soundToggle.onclick = () => {
  toggleSound();
  updateSoundButton();
};

// Terminal input formatting
function formatTerminalLines() {
  const lines = terminal.value.split('\n');
  const formatted = lines.map(line => {
    const trimmed = line.trim();
    if (trimmed === '') return '> ';
    if (trimmed.startsWith('>')) return trimmed;
    return '> ' + trimmed;
  });
  const newValue = formatted.join('\n');
  if (newValue !== terminal.value) {
    const cursorPos = terminal.selectionStart;
    terminal.value = newValue;
    terminal.setSelectionRange(cursorPos, cursorPos);
  }
}

// Handle Enter key - add > to new line
terminal.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const start = terminal.selectionStart;
    const end = terminal.selectionEnd;
    const text = terminal.value;
    const before = text.substring(0, start);
    const after = text.substring(end);
    terminal.value = before + '\n> ' + after;
    terminal.setSelectionRange(start + 3, start + 3);
  }
  
  // Handle Backspace at start of line - delete the line
  if (e.key === 'Backspace') {
    const start = terminal.selectionStart;
    const text = terminal.value;
    if (start >= 2 && text.substring(start - 2, start) === '> ') {
      const beforeCursor = text.substring(0, start - 2);
      if (beforeCursor.endsWith('\n') || beforeCursor === '') {
        e.preventDefault();
        const lineStart = text.substring(0, start - 2).lastIndexOf('\n') + 1;
        const lineEnd = text.indexOf('\n', start);
        const endPos = lineEnd === -1 ? text.length : lineEnd + 1;
        if (lineStart > 0) {
          terminal.value = text.substring(0, lineStart - 1) + text.substring(endPos);
          terminal.setSelectionRange(lineStart - 1, lineStart - 1);
        } else if (endPos < text.length) {
          terminal.value = text.substring(endPos);
          terminal.setSelectionRange(0, 0);
        }
      }
    }
  }
});

terminal.addEventListener('input', formatTerminalLines);

// Real-time score calculation
function updateScore() {
  const text = terminal.value;
  const lines = text.trim()
    .split('\n')
    .map(l => l.trim().replace(/^>\s*/, ''))
    .filter(l => l);
  
  if (lines.length === 0) {
    scoreDisplay.textContent = 'SCORE: 1000';
    return;
  }
  
  const result = engine.parse(lines.join('\n'));
  if (result.error || !result.actions) {
    scoreDisplay.textContent = 'SCORE: 1000';
    return;
  }
  
  const commandCount = countCommands(result.actions);
  const score = calculateScore(commandCount);
  scoreDisplay.textContent = `SCORE: ${score}`;
}

terminal.addEventListener('input', updateScore);
updateScore(); // Initialize score

// Initialize game state
engine.state.x = level.start.x;
engine.state.y = level.start.y;
engine.state.z = 0;
engine.state.facing = 'SE';

// Initialize renderer
initRenderer(() => {
  drawLevel(ctx, level, engine.state);
}, level);
drawLevel(ctx, level, engine.state);

document.getElementById('run').onclick = () => {
  status.textContent = '';
  
  const lines = terminal.value.split('\n')
    .map(line => line.trim().replace(/^>\s*/, ''))
    .filter(text => text.length > 0);
  
  const result = engine.parse(lines.join('\n'));
  if (result.error) {
    status.textContent = result.error;
    return;
  }

  if (!result.actions || result.actions.length === 0) {
    status.textContent = 'No commands to execute';
    return;
  }

  engine.execute(result.actions, s => drawLevel(ctx, level, s), s => {
    if (s.failed) {
      status.textContent = 'Game Over â€” Try Again';
    } else if (s.x === level.goal.x && s.y === level.goal.y) {
      const commandCount = countCommands(result.actions);
      const score = calculateScore(commandCount);
      scoreDisplay.textContent = `SCORE: ${score}`;
      status.textContent = 'âœ“ Level Complete';
      animateCelebration(s, (state) => drawLevel(ctx, level, state), 1500);
      saveMusicPosition(); // Save position before navigation
      setTimeout(() => window.location.href = 'level3.html', 2000);
    } else {
      status.textContent = 'Try again';
    }
  });
};

// Save music position before page unload
window.addEventListener('beforeunload', () => {
  saveMusicPosition();
});

// Navigation
document.getElementById('home-btn').onclick = () => {
  saveMusicPosition();
  window.location.href = '../index.html';
};

document.getElementById('prev-btn').onclick = () => {
  saveMusicPosition();
  window.location.href = 'level1.html';
};

document.getElementById('password-btn').onclick = () => {
  document.getElementById('password-modal').style.display = 'block';
};

// Password system
const passwordModal = document.getElementById('password-modal');
const closeBtn = document.querySelector('.close');
const passwordSubmit = document.getElementById('password-submit');

const passwords = {
  'level1': 'level1.html',
  'level2': 'level2.html',
  'level3': 'level3.html',
  'level4': 'level4.html',
  'level5': 'level5.html',
  'level6': 'level6.html',
  'level7': 'level7.html'
};

closeBtn.onclick = () => {
  passwordModal.style.display = 'none';
};

window.onclick = (e) => {
  if (e.target === passwordModal) {
    passwordModal.style.display = 'none';
  }
};

passwordSubmit.onclick = () => {
  const password = document.getElementById('password-input').value.trim().toLowerCase();
  const errorDiv = document.getElementById('password-error');
  
  if (passwords[password]) {
    saveMusicPosition();
    window.location.href = passwords[password];
  } else {
    errorDiv.textContent = 'Incorrect password';
  }
};
</script>
</body>
</html>
