<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Startie – Level 2</title>
<link rel="stylesheet" href="../style.css">
</head>
<body>
<div id="top-banner">
  <div id="banner-wrapper">
    <div id="banner-left"></div>
    <div id="banner-center">
      <img src="../assets/top-banner.png" alt="StartSchool LOGIC RUN" id="banner-img">
    </div>
    <div id="banner-right"></div>
  </div>
</div>

<div id="game-container">
  <div id="game">
    <canvas id="canvas" width="600" height="300"></canvas>
  </div>
  
  <div id="ui">
    <div id="ui-header">
      <strong>Level 2</strong>
      <span id="score">SCORE: 0</span>
    </div>
    <div id="terminal-container">
      <textarea id="terminal">> move()
> move()
> jump()
> move()</textarea>
    </div>
    <button id="run">Run</button>
    <div id="status"></div>
  </div>
</div>

<div id="nav-buttons">
  <button id="home-btn" class="nav-btn" title="Home"></button>
  <button id="prev-btn" class="nav-btn" title="Previous Level"></button>
  <button id="password-btn" class="nav-btn" title="Enter Password">*</button>
</div>

<!-- Password Modal -->
<div id="password-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Enter Level Password</h2>
    <input type="text" id="password-input" placeholder="Password">
    <button id="password-submit">Go</button>
    <div id="password-error"></div>
  </div>
</div>

<script type="module">
import { createEngine, calculateScore } from '../engine/index.js';
import { drawLevel, initRenderer } from '../render/index.js';
import { level2 } from './level2.js';

const level = level2;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const engine = createEngine(level);
const status = document.getElementById('status');
const scoreDisplay = document.getElementById('score');
const terminal = document.getElementById('terminal');

// Ensure each line starts with >
function formatTerminalLines() {
  const lines = terminal.value.split('\n');
  const formatted = lines.map(line => {
    const trimmed = line.trim();
    if (trimmed === '') return '> ';
    if (trimmed.startsWith('>')) return trimmed;
    return '> ' + trimmed;
  });
  const newValue = formatted.join('\n');
  if (newValue !== terminal.value) {
    const cursorPos = terminal.selectionStart;
    terminal.value = newValue;
    // Restore cursor position
    terminal.setSelectionRange(cursorPos, cursorPos);
  }
}

// Handle Enter key - add > to new line
terminal.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const start = terminal.selectionStart;
    const end = terminal.selectionEnd;
    const text = terminal.value;
    
    // Get current line
    const lines = text.substring(0, start).split('\n');
    const currentLine = lines[lines.length - 1];
    
    // Insert newline with >
    const before = text.substring(0, start);
    const after = text.substring(end);
    terminal.value = before + '\n> ' + after;
    
    // Set cursor after the >
    const newPos = start + 3;
    terminal.setSelectionRange(newPos, newPos);
  }
  
  // Handle Backspace at start of line (after >) - delete the line
  if (e.key === 'Backspace') {
    const start = terminal.selectionStart;
    const text = terminal.value;
    
    // Check if cursor is right after "> "
    if (start >= 2 && text.substring(start - 2, start) === '> ') {
      // Check if we're at the start of a line
      const beforeCursor = text.substring(0, start - 2);
      if (beforeCursor.endsWith('\n') || beforeCursor === '') {
        e.preventDefault();
        // Find the line start
        const lines = text.substring(0, start - 2).split('\n');
        const lineStart = text.substring(0, start - 2).lastIndexOf('\n') + 1;
        const lineEnd = text.indexOf('\n', start);
        const endPos = lineEnd === -1 ? text.length : lineEnd + 1;
        
        // Delete the line including the newline before it (if not first line)
        if (lineStart > 0) {
          terminal.value = text.substring(0, lineStart - 1) + text.substring(endPos);
          terminal.setSelectionRange(lineStart - 1, lineStart - 1);
        } else if (endPos < text.length) {
          terminal.value = text.substring(endPos);
          terminal.setSelectionRange(0, 0);
        }
      }
    }
  }
});

// Format on input
terminal.addEventListener('input', formatTerminalLines);

// Set initial state to level start position
engine.state.x = level.start.x;
engine.state.y = level.start.y;
engine.state.z = 0;
engine.state.facing = 'SE';

// Initialize renderer and draw initial state
initRenderer(() => {
  drawLevel(ctx, level, engine.state);
});
drawLevel(ctx, level, engine.state);

document.getElementById('run').onclick = () => {
  status.textContent = '';
  
  // Extract commands from terminal (remove > prefix)
  const lines = terminal.value.split('\n')
    .map(line => line.trim().replace(/^>\s*/, ''))
    .filter(text => text.length > 0);
  
  const result = engine.parse(lines.join('\n'));
  if (result.error) {
    status.textContent = result.error;
    return;
  }

  if (!result.actions || result.actions.length === 0) {
    status.textContent = 'No commands to execute';
    return;
  }

  engine.execute(result.actions, s => drawLevel(ctx, level, s), s => {
    console.log('Execution finished:', s);
    if (s.failed) {
      status.textContent = 'Game Over — Try Again';
    } else if (s.x === level.goal.x && s.y === level.goal.y) {
      const commandCount = lines.length;
      const score = calculateScore(commandCount);
      scoreDisplay.textContent = `SCORE: ${score}`;
      status.textContent = '✓ Level Complete';
      setTimeout(() => window.location.href = 'level3.html', 1500);
    } else {
      status.textContent = `Try again (at ${s.x}, ${s.y}, goal is ${level.goal.x}, ${level.goal.y})`;
    }
  });
};

// Navigation buttons
document.getElementById('home-btn').onclick = () => {
  window.location.href = '../index.html';
};

document.getElementById('prev-btn').onclick = () => {
  window.location.href = 'level1.html';
};

document.getElementById('password-btn').onclick = () => {
  document.getElementById('password-modal').style.display = 'block';
};

// Password modal
const modal = document.getElementById('password-modal');
const closeBtn = document.querySelector('.close');
const passwordSubmit = document.getElementById('password-submit');

closeBtn.onclick = () => {
  modal.style.display = 'none';
};

window.onclick = (e) => {
  if (e.target === modal) {
    modal.style.display = 'none';
  }
};

passwordSubmit.onclick = () => {
  const password = document.getElementById('password-input').value;
  const errorDiv = document.getElementById('password-error');
  
  // Simple password system - can be expanded
  if (password === 'level3') {
    window.location.href = 'level3.html';
  } else {
    errorDiv.textContent = 'Incorrect password';
  }
};
</script>
</body>
</html>
